{% extends "base.html" %}
{% block content %}

<style>
  :root{
    --bg:#fafafa;
    --card:#fff;
    --text:#0f172a;
    --muted:#64748b;
    --border:#e5e7eb;
    --shadow:0 10px 30px rgba(2, 6, 23, 0.08);
    --blue:#0b5fff;
  }

  .wrap{ max-width: 980px; margin: 24px auto; padding: 0 16px; }
  .shell{
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 18px;
    box-shadow: var(--shadow);
    overflow: hidden;
  }

  .topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    background: linear-gradient(to bottom, #fff, #fafafa);
  }
  .title{
    font-weight: 900;
    letter-spacing: -0.02em;
    color: var(--text);
    font-size: 18px;
  }
  .actions{ display:flex; gap:10px; align-items:center; }
  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding: 9px 12px;
    border-radius: 15px;
    border: 1px solid var(--border);
    background: #fff;
    color: var(--text);
    text-decoration:none;
    font-weight: 800;
    font-size: 13px;
    cursor:pointer;
  }
  .pill.primary{
    background: var(--blue);
    border-color: transparent;
    color: white;
  }
  .pill:hover{ filter: brightness(0.98); }

  /* IG list */
  .list{ background: var(--bg); padding: 10px; }
  .row{
    display:flex;
    gap: 12px;
    align-items:center;
    padding: 12px 12px;
    border-radius: 14px;
    text-decoration:none;
    color: inherit;
  }
  .row:hover{ background: #fff; box-shadow: 0 6px 16px rgba(2,6,23,0.06); }

  .avatar{
    width: 48px; height: 48px;
    border-radius: 999px;
    object-fit: cover;
    border: 1px solid var(--border);
    flex: 0 0 auto;
  }

  .mid{ min-width: 0; flex: 1; }
  .name-line{
    display:flex;
    align-items:center;
    gap:8px;
    min-width: 0;
  }
  .name{
    font-weight: 900;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .handle{
    color: var(--muted);
    font-size: 12px;
    font-weight: 800;
    white-space: nowrap;
  }

  .preview{
    margin-top: 4px;
    color: var(--muted);
    font-size: 13px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .right{
    display:flex;
    flex-direction:column;
    align-items:flex-end;
    gap: 6px;
    flex: 0 0 auto;
  }
  .time{
    color: var(--muted);
    font-size: 12px;
    font-weight: 800;
    white-space: nowrap;
  }
  .badge{
    width: 10px;
    height: 10px;
    border-radius: 999px;
    background: #ef4444;
    box-shadow: 0 0 0 3px rgba(239,68,68,0.18);
  }

  /* New message modal-ish box */
  .composer{
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    background: #fff;
    display:none;
  }
  .composer.open{ display:block; }
  .grid{
    display:grid;
    grid-template-columns: 1fr 1fr 120px;
    gap: 10px;
    align-items:end;
  }
  .results{
    grid-column: 1 / -1;
    background: #f8fafc;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 8px;
    display:none;
  }
  .results.open{ display:block; }
  .result-item{
    display:flex;
    align-items:center;
    gap: 10px;
    padding: 8px;
    border-radius: 10px;
    cursor: pointer;
  }
  .result-item:hover{ background:#fff; }
  .result-avatar{
    width: 32px;
    height: 32px;
    border-radius: 999px;
    object-fit: cover;
    border: 1px solid var(--border);
  }
  .result-name{
    font-weight: 900;
    color: var(--text);
    font-size: 13px;
  }
  .result-handle{
    color: var(--muted);
    font-weight: 800;
    font-size: 12px;
  }
  .field label{
    display:block;
    font-size: 12px;
    font-weight: 900;
    color: var(--muted);
    margin-bottom: 6px;
  }
  .field input{
    width: 90%;
    height: 44px;
    padding: 0 12px;
    border-radius: 12px;
    border: 1px solid var(--border);
    outline: none;
    font-size: 14px;
  }
  .field input:focus{
    border-color: #93c5fd;
    box-shadow: 0 0 0 4px rgba(147,197,253,0.25);
  }

  @media (max-width: 760px){
    .grid{ grid-template-columns: 1fr; }
  }
</style>

<div class="wrap">
  <div class="shell">
    <div class="topbar">
      <div class="title">Messages</div>
      <div class="actions">
        <button class="pill primary" type="button" onclick="toggleComposer()">
          + New message
        </button>
      </div>
    </div>

    <div id="composer" class="composer">
      <form method="post" action="{{ url_for('start_conversation') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="grid">
          <div class="field">
            <label>Recipient (@username)</label>
            <input id="recipient_search" placeholder="@djname" autocomplete="off">
            <input type="hidden" id="recipient_id" name="recipient_id">
          </div>
          <div class="field">
            <label>Message</label>
            <input name="body" placeholder="Write a messageâ€¦" required>
          </div>
          <button class="pill primary" type="submit">Send message</button>
          <div id="recipient_results" class="results" aria-live="polite"></div>
        </div>
      </form>
    </div>

    <div class="list">
      {% if items|length == 0 %}
        <div style="padding:18px; color: var(--muted); font-weight:800; text-align:center;">
          No conversations yet.
        </div>
      {% else %}
        {% for it in items %}
          <a class="row" href="{{ url_for('view_conversation', conversation_id=it.convo.id) }}">
            <img class="avatar" src="{{ it.avatar }}" alt="avatar">
            <div class="mid">
              <div class="name-line">
                <div class="name">{{ it.other_name }}</div>
                <div class="handle">@{{ it.other_username }}</div>
              </div>
              <div class="preview">
                {{ it.last_text if it.last_text else "Say hi ðŸ‘‹" }}
              </div>
            </div>
            <div class="right">
              <div class="time">
                {{ it.last_at.strftime("%b %d, %I:%M %p") if it.last_at else "" }}
              </div>
              {% if it.unread_count and it.unread_count > 0 %}
                <div class="badge"></div>
              {% endif %}
            </div>
          </a>
        {% endfor %}
      {% endif %}
    </div>
  </div>
</div>

<script>
  function toggleComposer(){
    const el = document.getElementById("composer");
    el.classList.toggle("open");
  }

  const searchInput = document.getElementById("recipient_search");
  const resultsEl = document.getElementById("recipient_results");
  const recipientId = document.getElementById("recipient_id");
  let searchTimer;

  function renderResults(items){
    if (!items.length){
      resultsEl.innerHTML = '<div style="padding:8px;color:#64748b;font-weight:800;">No matches.</div>';
      resultsEl.classList.add("open");
      return;
    }
    resultsEl.innerHTML = items.map(p => `
      <div class="result-item" data-id="${p.id}" data-username="${p.username}">
        <img class="result-avatar" src="${p.avatar_url}" alt="">
        <div>
          <div class="result-name">@${p.username}</div>
          <div class="result-handle">Select to message</div>
        </div>
      </div>
    `).join("");
    resultsEl.classList.add("open");
  }

  resultsEl?.addEventListener("click", (e) => {
    const item = e.target.closest(".result-item");
    if (!item) return;
    recipientId.value = item.dataset.id;
    searchInput.value = `@${item.dataset.username}`;
    resultsEl.classList.remove("open");
  });

  searchInput?.addEventListener("input", () => {
    clearTimeout(searchTimer);
    recipientId.value = "";
    const q = searchInput.value.trim().replace(/^@+/, "");
    if (!q){
      resultsEl.classList.remove("open");
      resultsEl.innerHTML = "";
      return;
    }
    searchTimer = setTimeout(async () => {
      const res = await fetch(`/api/profiles/search?q=${encodeURIComponent(q)}`);
      const data = await res.json();
      renderResults(data.profiles || []);
    }, 200);
  });
</script>

{% endblock %}
