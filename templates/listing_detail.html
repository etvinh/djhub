{% extends "base.html" %}
{% block title %}Listing · DJHub{% endblock %}

{% block content %}
<style>
  .booking-actions{
    margin-top: 12px;
    display:flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .booking-actions-group{
    display:flex;
    align-items:flex-start;
    gap: 8px;
    flex-wrap: wrap;
  }
  .booking-actions-group form{
    display:flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .booking-btn{
    height: 36px;
    padding: 0 14px;
    border-radius: 999px;
    border: 0;
    background: #111827;
    color: #fff;
    font-weight: 800;
    cursor: pointer;
  }
  .booking-btn.secondary{
    background: #e5e7eb;
    color: #111827;
  }
  .booking-actions-group .message-btn{
    height: 36px;
    padding: 0 14px;
    border-radius: 999px;
    border: 1px solid #e5e7eb;
    background: #fff;
    color: #111827;
    font-weight: 800;
    cursor: pointer;
  }
  .requester{
    display:flex;
    align-items:center;
    gap: 10px;
    font-weight:800;
    color:#111827;
  }
  .requester a{
    color: inherit;
    text-decoration: none;
    font-weight: 800;
  }
  .requester-avatar{
    width: 36px;
    height: 36px;
    border-radius: 999px;
    object-fit: cover;
    border: 1px solid #e2e8f0;
  }
  .booking-chip{
    display:inline-flex;
    align-items:center;
    height: 28px;
    padding: 0 10px;
    border-radius: 999px;
    background: #f3f4f6;
    color: #111827;
    font-weight: 800;
    font-size: 12px;
  }
  .gallery{
    display: grid;
    gap: 12px;
  }
  .gallery img{
    width: 100%;
    aspect-ratio: 1 / 1;
    object-fit: cover;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
  }
  .archived-banner{
    margin-top: 10px;
    padding: 10px 12px;
    border-radius: 12px;
    background: #f1f5f9;
    color: #0f172a;
    font-weight: 800;
    font-size: 12px;
    border: 1px solid #e2e8f0;
  }
  .accept-warning{
    display:inline-flex;
    align-items:center;
    height: 28px;
    padding: 0 10px;
    border-radius: 999px;
    background: #fffbeb;
    color: #b45309;
    border: 1px solid #fcd34d;
    font-weight: 800;
    font-size: 11px;
  }
</style>
<div style="max-width: 780px; margin: 24px auto; padding: 0 16px;">
  <a href="{{ url_for('listings_feed') }}" style="display:inline-block;margin-bottom:16px;color:#2563eb;text-decoration:none;">
    ← Back to feed
  </a>

  <div style="padding:16px;border:1px solid #e5e7eb;border-radius:16px;background:#fff;">
    <h1 style="margin:0 0 8px 0;">{{ listing.title }}</h1>
    {% if listing.is_archived %}
      <div class="archived-banner">This listing is archived and only visible to the planner and booked DJ.</div>
    {% endif %}

    <div style="color:#6b7280; display:flex; flex-wrap:wrap; gap:10px; margin-top:6px;">
      {% if listing.date %}<span><strong>Date:</strong> {{ listing.date.strftime("%b %d, %Y") }}</span>{% endif %}
      {% if listing.time %}<span><strong>Time:</strong> {{ listing.time }}</span>{% endif %}
      {% if listing.city %}<span><strong>Location:</strong> {{ listing.city }}</span>{% endif %}
      {% if listing.budget %}<span><strong>Budget:</strong> ${{ listing.budget }}</span>{% endif %}
      {% if listing.genres %}<span><strong>Genre:</strong> {{ listing.genres }}</span>{% endif %}
    </div>

    {% if listing.description %}
      <div style="margin-top:16px;">
        <h3 style="margin:0 0 8px 0;">Details</h3>
        <div style="white-space:pre-wrap; color:#111827;">{{ listing.description }}</div>
      </div>
    {% endif %}

    {% from "_message_box.html" import message_box with context %}

    <div style="margin-top:16px;padding-top:14px;border-top:1px solid #e5e7eb;">
      {% if listing.profile %}
        <p style="margin:0;color:#6b7280;">
          Posted by
          <a href="{{ url_for('profile_detail', profile_id=listing.profile.id) }}"
             style="color:#2563eb;text-decoration:none;font-weight:800;">
            {{ listing.profile.user.username }}
          </a>
        </p>
        {% if current_user.is_authenticated and current_user.id == listing.profile.user_id %}
          <div style="margin-top:10px;">
            <a href="{{ url_for('edit_listing', listing_id=listing.id) }}"
               style="display:inline-flex;align-items:center;justify-content:center;height:32px;padding:0 12px;border-radius:999px;background:#0f172a;color:#fff;font-weight:800;text-decoration:none;">
              Edit listing
            </a>
          </div>
        {% endif %}

        {% if not current_user.is_authenticated or current_user.id != listing.profile.user_id %}
          <div style="margin-top:12px;">
            {{ message_box(listing.profile.user_id) }}
          </div>
        {% endif %}
      {% else %}
        <p style="margin:0;color:#6b7280;">Posted by DJHub</p>
      {% endif %}
    </div>

    {% if listing.profile %}
      {% if current_user.is_authenticated and current_user.id == listing.profile.user_id %}
        <div style="margin-top:14px;padding-top:14px;border-top:1px solid #e5e7eb;">
          <h3 style="margin:0 0 10px 0;">Booking requests</h3>
          {% for req in booking_requests %}
            <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 0;border-top:1px solid #f3f4f6;">
              <div class="requester">
                {% set rp = requester_profiles.get(req.requester_id) %}
                {% if rp %}
                  <a href="{{ url_for('profile_detail', profile_id=rp.id) }}">
                    <img class="requester-avatar" src="{{ rp.avatar_url or url_for('static', filename='default-avatar.png') }}" alt="{{ req.requester.username }}">
                  </a>
                  <a href="{{ url_for('profile_detail', profile_id=rp.id) }}">
                    {{ req.requester.username }}
                  </a>
                {% else %}
                  <img class="requester-avatar" src="{{ url_for('static', filename='default-avatar.png') }}" alt="{{ req.requester.username }}">
                  <span>{{ req.requester.username }}</span>
                {% endif %}
                {% if req.status == "accepted" %}
                  <span style="color:#6b7280;font-weight:700;">booked the event</span>
                {% else %}
                  <span style="color:#6b7280;font-weight:700;">requested to book</span>
                {% endif %}
              </div>
              {% if req.status == "pending" and not listing.is_archived %}
                <div class="booking-actions-group">
                  <form method="POST" action="{{ url_for('respond_booking', booking_id=req.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" name="action" value="accept" class="booking-btn">Accept</button>
                    <span class="accept-warning">Accepting archives the listing</span>
                    <button type="submit" name="action" value="decline" class="booking-btn secondary">Decline</button>
                  </form>
                  <div>
                    {% from "_message_box.html" import message_box with context %}
                    <button type="button" class="message-btn" onclick="
                      const box = document.getElementById('msg-{{ req.requester_id }}');
                      box.style.display = 'block';
                      const ta = box.querySelector('textarea');
                      if (ta) ta.focus();
                    ">
                      Message
                    </button>
                    <div id="msg-{{ req.requester_id }}" style="display:none;margin-top:10px;">
                      {% if is_logged_in %}
                        <form method="post" action="{{ url_for('start_conversation') }}">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <input type="hidden" name="recipient_id" value="{{ req.requester_id }}">
                          <textarea name="body"
                            rows="3"
                            placeholder="Write a message…"
                            style="width:100%;padding:8px;border-radius:8px;"
                            required></textarea>
                          <div style="margin-top:6px;display:flex;gap:8px;">
                            <button type="submit" class="booking-btn">Send message</button>
                            <button type="button" class="booking-btn secondary"
                              onclick="document.getElementById('msg-{{ req.requester_id }}').style.display='none'">
                              Cancel
                            </button>
                          </div>
                        </form>
                      {% else %}
                        <div style="padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;">
                          <div style="margin-bottom:8px;color:#111827;">
                            Create an account to start messaging.
                          </div>
                          <div style="display:flex;gap:8px;flex-wrap:wrap;">
                            <a href="{{ url_for('signup') }}"
                               style="display:inline-block;padding:8px 12px;border-radius:10px;background:#2563eb;color:#fff;text-decoration:none;">
                              Sign up
                            </a>
                            <a href="{{ url_for('login') }}"
                               style="display:inline-block;padding:8px 12px;border-radius:10px;border:1px solid #e5e7eb;text-decoration:none;">
                              Log in
                            </a>
                            <button type="button"
                              onclick="document.getElementById('msg-{{ req.requester_id }}').style.display='none'"
                              style="padding:8px 12px;border-radius:10px;">
                              Cancel
                            </button>
                          </div>
                        </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              {% else %}
                <span class="booking-chip">{{ req.status }}</span>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div style="margin-top:14px;padding-top:14px;border-top:1px solid #e5e7eb;">
          {% if listing.is_archived %}
            {% if current_request %}
              <span class="booking-chip">Booking {{ current_request.status }}</span>
            {% else %}
              <span class="booking-chip">Listing archived</span>
            {% endif %}
          {% else %}
            {% if current_request %}
              <span class="booking-chip">Request {{ current_request.status }}</span>
            {% elif current_user.is_authenticated %}
              <form method="POST" action="{{ url_for('request_booking', listing_id=listing.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="booking-btn">Request booking</button>
              </form>
            {% else %}
              <button type="button" class="booking-btn"
                onclick="document.getElementById('auth-request').style.display='block';">
                Request booking
              </button>
              <div id="auth-request" style="display:none;margin-top:10px;">
                <div style="padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;">
                  <div style="margin-bottom:8px;color:#111827;font-weight:800;">
                    Create an account to request bookings.
                  </div>
                  <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    <a href="{{ url_for('signup') }}"
                       style="display:inline-block;padding:8px 12px;border-radius:10px;background:#2563eb;color:#fff;text-decoration:none;">
                      Sign up
                    </a>
                    <a href="{{ url_for('login') }}"
                       style="display:inline-block;padding:8px 12px;border-radius:10px;border:1px solid #e5e7eb;text-decoration:none;">
                      Log in
                    </a>
                    <button type="button"
                      onclick="document.getElementById('auth-request').style.display='none'"
                      style="padding:8px 12px;border-radius:10px;">
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            {% endif %}
          {% endif %}
        </div>
      {% endif %}
    {% endif %}

    {% if listing.photos %}
      <div style="margin-top:16px;padding-top:14px;border-top:1px solid #e5e7eb;">
        <h3 style="margin:0 0 8px 0;">Photos</h3>
        <div class="gallery">
          {% for photo in listing.photos %}
            <img src="{{ photo.image_url }}" alt="{{ listing.title }}">
          {% endfor %}
        </div>
      </div>
    {% endif %}

  </div>
</div>
{% endblock %}
