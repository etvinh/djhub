{% extends "base.html" %}
{% block title %}Listing · DJHub{% endblock %}

{% block content %}
<style>
  :root{
    --bg:#1a0d2b;
    --card: rgba(26,12,55,0.92);
    --text:#f8fafc;
    --muted:rgba(226,232,240,0.72);
    --border: rgba(255,255,255,0.12);
    --shadow:0 18px 50px rgba(9,6,23,0.35);
    --purple:#6c4bff;
  }
  .detail-page{
    max-width: 880px;
    margin: 24px auto 80px;
    padding: 0 16px;
    color: var(--text);
  }
  .back-link{
    display:inline-flex;
    align-items:center;
    margin-bottom: 16px;
    color: #c4b5fd;
    text-decoration: none;
    font-weight: 800;
  }
  .detail-card{
    padding: 18px;
    border-radius: 18px;
    background: var(--card);
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
  }
  .detail-title{
    margin: 0 0 8px 0;
    font-size: 24px;
    font-weight: 900;
  }
  .detail-meta{
    color: var(--muted);
    display:flex;
    flex-wrap:wrap;
    gap: 10px;
    margin-top: 6px;
    font-size: 12px;
    font-weight: 700;
  }
  .detail-section{
    margin-top: 16px;
    padding-top: 14px;
    border-top: 1px solid rgba(255,255,255,0.10);
  }
  .section-title{
    margin: 0 0 8px 0;
    font-size: 12px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    font-weight: 900;
    color: #e5e7eb;
  }
  .archived-banner{
    margin-top: 10px;
    padding: 10px 12px;
    border-radius: 12px;
    background: rgba(255,255,255,0.08);
    color: #e5e7eb;
    font-weight: 800;
    font-size: 12px;
    border: 1px solid rgba(255,255,255,0.12);
  }
  .booking-actions{
    margin-top: 12px;
    display:flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .booking-actions-group{
    display:flex;
    align-items:flex-start;
    gap: 8px;
    flex-wrap: wrap;
  }
  .booking-actions-group form{
    display:flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .booking-btn{
    height: 36px;
    padding: 0 14px;
    border-radius: 999px;
    border: 0;
    background: var(--purple);
    color: #fff;
    font-weight: 800;
    cursor: pointer;
  }
  .booking-btn.secondary{
    background: rgba(255,255,255,0.12);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.16);
  }
  .booking-actions-group .message-btn{
    height: 36px;
    padding: 0 14px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.16);
    background: rgba(255,255,255,0.08);
    color: #fff;
    font-weight: 800;
    cursor: pointer;
  }
  .requester{
    display:flex;
    align-items:center;
    gap: 10px;
    font-weight:800;
    color:#fff;
  }
  .requester a{
    color: inherit;
    text-decoration: none;
    font-weight: 800;
  }
  .requester-avatar{
    width: 36px;
    height: 36px;
    border-radius: 999px;
    object-fit: cover;
    border: 1px solid rgba(255,255,255,0.16);
  }
  .booking-chip{
    display:inline-flex;
    align-items:center;
    height: 28px;
    padding: 0 10px;
    border-radius: 999px;
    background: rgba(255,255,255,0.12);
    color: #fff;
    font-weight: 800;
    font-size: 12px;
  }
  .gallery{
    display: grid;
    gap: 12px;
  }
  .gallery img{
    width: 100%;
    aspect-ratio: 1 / 1;
    object-fit: cover;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.12);
  }
  .accept-warning{
    display:inline-flex;
    align-items:center;
    height: 28px;
    padding: 0 10px;
    border-radius: 999px;
    background: rgba(234,179,8,0.16);
    color: #fde68a;
    border: 1px solid rgba(234,179,8,0.35);
    font-weight: 800;
    font-size: 11px;
  }
</style>
<div class="detail-page">
  <a class="back-link" href="{{ url_for('listings_feed') }}">← Back to feed</a>

  <div class="detail-card">
    <h1 class="detail-title">{{ listing.title }}</h1>
    {% if listing.is_archived %}
      <div class="archived-banner">This listing is archived and only visible to the planner and booked DJ.</div>
    {% endif %}

    <div class="detail-meta">
      {% if listing.date %}<span><strong>Date:</strong> {{ listing.date.strftime("%b %d, %Y") }}</span>{% endif %}
      {% if listing.time %}<span><strong>Time:</strong> {{ listing.time }}</span>{% endif %}
      {% if listing.city %}<span><strong>Location:</strong> {{ listing.city }}</span>{% endif %}
      {% if listing.budget %}<span><strong>Budget:</strong> ${{ listing.budget }}</span>{% endif %}
      {% if listing.genres %}<span><strong>Genre:</strong> {{ listing.genres }}</span>{% endif %}
    </div>

    {% if listing.description %}
      <div class="detail-section">
        <h3 class="section-title">Details</h3>
        <div style="white-space:pre-wrap; color:rgba(226,232,240,0.9);">{{ listing.description }}</div>
      </div>
    {% endif %}

    {% from "_message_box.html" import message_box with context %}

    <div class="detail-section">
      {% if listing.profile %}
        <p style="margin:0;color:var(--muted);">
          Posted by
          <a href="{{ url_for('profile_detail', profile_id=listing.profile.id) }}"
             style="color:#c4b5fd;text-decoration:none;font-weight:800;">
            {{ listing.profile.user.username }}
          </a>
        </p>
        {% if current_user.is_authenticated and current_user.id == listing.profile.user_id %}
          <div style="margin-top:10px;">
            <a href="{{ url_for('edit_listing', listing_id=listing.id) }}"
               style="display:inline-flex;align-items:center;justify-content:center;height:32px;padding:0 12px;border-radius:999px;background:#6c4bff;color:#fff;font-weight:800;text-decoration:none;">
              Edit listing
            </a>
          </div>
        {% endif %}

        {% if not current_user.is_authenticated or current_user.id != listing.profile.user_id %}
          <div style="margin-top:12px;">
            {{ message_box(listing.profile.user_id) }}
          </div>
        {% endif %}
      {% else %}
        <p style="margin:0;color:#6b7280;">Posted by DJHub</p>
      {% endif %}
    </div>

    {% if listing.profile %}
      {% if current_user.is_authenticated and current_user.id == listing.profile.user_id %}
        <div class="detail-section">
          <h3 class="section-title">Booking requests</h3>
          {% for req in booking_requests %}
            <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 0;border-top:1px solid rgba(255,255,255,0.10);">
              <div class="requester">
                {% set rp = requester_profiles.get(req.requester_id) %}
                {% if rp %}
                  <a href="{{ url_for('profile_detail', profile_id=rp.id) }}">
                    <img class="requester-avatar" src="{{ rp.avatar_url or url_for('static', filename='default-avatar.png') }}" alt="{{ req.requester.username }}">
                  </a>
                  <a href="{{ url_for('profile_detail', profile_id=rp.id) }}">
                    {{ req.requester.username }}
                  </a>
                {% else %}
                  <img class="requester-avatar" src="{{ url_for('static', filename='default-avatar.png') }}" alt="{{ req.requester.username }}">
                  <span>{{ req.requester.username }}</span>
                {% endif %}
                {% if req.status == "accepted" %}
                  <span style="color:var(--muted);font-weight:700;">booked the event</span>
                {% else %}
                  <span style="color:var(--muted);font-weight:700;">requested to book</span>
                {% endif %}
              </div>
              {% if req.status == "pending" and not listing.is_archived %}
                <div class="booking-actions-group">
                  <form method="POST" action="{{ url_for('respond_booking', booking_id=req.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" name="action" value="accept" class="booking-btn">Accept</button>
                    <span class="accept-warning">Accepting archives the listing</span>
                    <button type="submit" name="action" value="decline" class="booking-btn secondary">Decline</button>
                  </form>
                  <div>
                    {% from "_message_box.html" import message_box with context %}
                    <button type="button" class="message-btn" onclick="
                      const box = document.getElementById('msg-{{ req.requester_id }}');
                      box.style.display = 'block';
                      const ta = box.querySelector('textarea');
                      if (ta) ta.focus();
                    ">
                      Message
                    </button>
                    <div id="msg-{{ req.requester_id }}" style="display:none;margin-top:10px;">
                      {% if is_logged_in %}
                        <form method="post" action="{{ url_for('start_conversation') }}">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <input type="hidden" name="recipient_id" value="{{ req.requester_id }}">
                          <textarea name="body"
                            rows="3"
                            placeholder="Write a message…"
                            style="width:100%;padding:8px;border-radius:8px;"
                            required></textarea>
                          <div style="margin-top:6px;display:flex;gap:8px;">
                            <button type="submit" class="booking-btn">Send message</button>
                            <button type="button" class="booking-btn secondary"
                              onclick="document.getElementById('msg-{{ req.requester_id }}').style.display='none'">
                              Cancel
                            </button>
                          </div>
                        </form>
                      {% else %}
                        <div style="padding:10px;border:1px solid rgba(255,255,255,0.16);border-radius:10px;background:rgba(26,12,55,0.95);">
                          <div style="margin-bottom:8px;color:#fff;">
                            Create an account to start messaging.
                          </div>
                          <div style="display:flex;gap:8px;flex-wrap:wrap;">
                            <a href="{{ url_for('signup') }}"
                               style="display:inline-block;padding:8px 12px;border-radius:10px;background:#6c4bff;color:#fff;text-decoration:none;">
                              Sign up
                            </a>
                            <a href="{{ url_for('login') }}"
                               style="display:inline-block;padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.16);color:#fff;text-decoration:none;">
                              Log in
                            </a>
                            <button type="button"
                              onclick="document.getElementById('msg-{{ req.requester_id }}').style.display='none'"
                              style="padding:8px 12px;border-radius:10px;">
                              Cancel
                            </button>
                          </div>
                        </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              {% else %}
                <span class="booking-chip">{{ req.status }}</span>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="detail-section">
          {% if listing.is_archived %}
            {% if current_request %}
              <span class="booking-chip">Booking {{ current_request.status }}</span>
            {% else %}
              <span class="booking-chip">Listing archived</span>
            {% endif %}
          {% else %}
            {% if current_request %}
              <span class="booking-chip">Request {{ current_request.status }}</span>
            {% elif current_user.is_authenticated %}
              <form method="POST" action="{{ url_for('request_booking', listing_id=listing.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="booking-btn">Request booking</button>
              </form>
            {% else %}
              <button type="button" class="booking-btn"
                onclick="document.getElementById('auth-request').style.display='block';">
                Request booking
              </button>
              <div id="auth-request" style="display:none;margin-top:10px;">
                <div style="padding:10px;border:1px solid rgba(255,255,255,0.16);border-radius:10px;background:rgba(26,12,55,0.95);">
                  <div style="margin-bottom:8px;color:#fff;font-weight:800;">
                    Create an account to request bookings.
                  </div>
                  <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    <a href="{{ url_for('signup') }}"
                       style="display:inline-block;padding:8px 12px;border-radius:10px;background:#6c4bff;color:#fff;text-decoration:none;">
                      Sign up
                    </a>
                    <a href="{{ url_for('login') }}"
                       style="display:inline-block;padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.16);color:#fff;text-decoration:none;">
                      Log in
                    </a>
                    <button type="button"
                      onclick="document.getElementById('auth-request').style.display='none'"
                      style="padding:8px 12px;border-radius:10px;">
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            {% endif %}
          {% endif %}
        </div>
      {% endif %}
    {% endif %}

    {% if listing.photos %}
      <div class="detail-section">
        <h3 class="section-title">Photos</h3>
        <div class="gallery">
          {% for photo in listing.photos %}
            <img src="{{ photo.image_url }}" alt="{{ listing.title }}">
          {% endfor %}
        </div>
      </div>
    {% endif %}

  </div>
</div>
{% endblock %}
