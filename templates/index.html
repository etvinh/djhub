{% extends "base.html" %}
{% block title %}DJHub ‚Äî Listings{% endblock %}

{% block head %}
  <meta charset="utf-8" />
  <title>DJHub ‚Äî Listings</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <style>
    /* If your base.html supports block head, this will load.
       We also include the same CSS again in block content as a fallback. */
  </style>
{% endblock %}

{% block content %}

<style>
  /* ===== Page-scoped styling ===== */
  .djhub-feed * { box-sizing: border-box; }
  .djhub-feed{
    font-family: var(--font);
    color: #0f172a;
    margin: 0;
  }
  body{
    background: url("{{ url_for('static', filename='img/feedbackground.png') }}") center / cover fixed no-repeat;
    position: relative;
  }
  body::before{
    content: "";
    position: fixed;
    inset: 0;
    pointer-events: none;
    background: rgba(15,23,42,0.45);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    z-index: 0;
  }
  .djhub-feed{
    position: relative;
    z-index: 1;
  }

  /* kill default list/bullets/blue links regardless of global CSS */
  .djhub-feed a{ color: inherit; text-decoration: none; }
  .djhub-feed ul{ list-style: none !important; padding: 0 !important; margin: 0 !important; }
  .djhub-feed li{ margin: 0; padding: 0; }

  :root{
    --bg: #f6f7fb;
    --card: #ffffff;
    --text: #0f172a;
    --muted: #64748b;
    --border: #e5e7eb;
    --shadow: 0 18px 50px rgba(2,6,23,0.18);
    --shadow2: 0 12px 28px rgba(2,6,23,0.14);
    --radius: 18px;
    --blue: #2f6bff;
  }

  /* ===== Hero (matches your reference) ===== */
  .hero{
    position: relative;
    min-height: 410px;
    border-radius: 18px;
    overflow: hidden;
    border: 1px solid rgba(5, 8, 20, 0.65);
    background:
      linear-gradient(90deg, rgba(8,12,28,0.92) 0%, rgba(10,16,40,0.62) 55%, rgba(10,20,52,0.28) 100%),
      url("{{ url_for('static', filename='img/hero-dj.jpg') }}");
    background-size: cover;
    background-position: center var(--parallax-y, center);
    box-shadow: var(--shadow);
    margin-top: 80px;
  }
  .hero::before{
    content: "";
    position: absolute;
    inset: 0;
    background:
      linear-gradient(120deg, rgba(255,255,255,0.14) 0%, rgba(255,255,255,0.05) 35%, rgba(255,255,255,0.0) 62%),
      radial-gradient(700px 260px at 20% 0%, rgba(79,124,255,0.35), transparent 60%);
    mix-blend-mode: screen;
    pointer-events: none;
  }
  .hero-inner{
    position: relative;
    z-index: 1;
  }

  .hero-inner{
    max-width: 1100px;
    margin: 0 auto;
    padding: 44px 18px 0;
  }

  .hero-content{
    max-width: 640px;
    padding: 0 10px;
  }

  .hero h1{
    margin: 0;
    font-size: 44px;
    line-height: 1.05;
    letter-spacing: -0.03em;
    color: #fff;
    font-weight: 900;
    text-transform: uppercase;
    font-family: "Orbitron", var(--font);
    background: linear-gradient(180deg, #ffffff 0%, #c7b9ff 45%, #f5f3ff 100%);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    text-shadow: 0 8px 22px rgba(9,6,23,0.45);
  }

  .hero p{
    margin: 12px 0 18px;
    max-width: 560px;
    color: rgba(226,232,240,0.86);
    font-weight: 600;
    font-size: 14px;
  }

  /* Optional hero CTA buttons (pure front-end). Not required. */
  .hero-ctas{
    display:flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 16px;
  }
  .pill{
    display:inline-flex;
    align-items:center;
    padding: 10px 14px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.16);
    background: rgba(255,255,255,0.10);
    color: #fff;
    font-weight: 900;
    font-size: 12px;
    backdrop-filter: blur(6px);
  }
  .hero .pill{
    color: #fff;
  }
  .pill.primary{
    background: var(--blue);
    border-color: transparent;
  }

  /* ===== Search bar visual (no backend changes) ===== */
  .search-wrap{
    max-width: 900px;
    margin: 36px auto 0;
    padding: 0 16px;
    
    
  }
  .searchbar{
    background: #ffffff;
    border-radius: 12px;
    padding: 10px;
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    box-shadow: 0 18px 50px rgba(15,23,42,0.12);
    border: 1px solid rgba(15,23,42,0.10);
  }
  .searchbar input{
    height: 40px;

    border-radius: 10px;
    border: 1px solid #e2e8f0;
    padding: 0 12px;
    outline: none;
    font-weight: 650;
    color: #0f172a;
    background: #f8fafc;
  }
  .searchbar select{
    height: 40px;
    border-radius: 10px;
    border: 1px solid #e2e8f0;
    padding: 0 32px 0 12px;
    outline: none;
    font-weight: 650;
    color: #0f172a;
    background: #f8fafc;
    appearance: none;
  }
  .searchbar input:focus{
    border-color: #93c5fd;
    box-shadow: 0 0 0 4px rgba(147,197,253,0.35);
  }
  .searchbar select:focus{
    border-color: #93c5fd;
    box-shadow: 0 0 0 4px rgba(147,197,253,0.35);
  }
  .searchbar button{
    height: 40px;
    border: 0;
    border-radius: 10px;
    background: #1f2a44;
    color: #fff;
    font-weight: 900;
    cursor: pointer;
  }

  /* ===== Main section ===== */
  .wrap{
    max-width: 1100px;
    margin: 0 auto;
    padding: 0 16px 70px;
  }

  .section-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 16px;
    margin: 56px 0 12px;
  }
  .section-title{
    margin: 56px 0 12px;
    font-size: 13px;
    letter-spacing: 0.10em;
    text-transform: uppercase;
    font-weight: 900;
    color: #fff;
  }
  .section-row .section-title{
    margin: 0;
  }
  .sort-form{
    display:flex;
    align-items:center;
    gap: 8px;
  }
  .sort-label{
    font-weight: 900;
    font-size: 12px;
    color: #fff;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }
  .sort-form select{
    height: 40px;
    padding: 0 12px;
    border-radius: 10px;
    border: 1px solid #cbd5f5;
    font-weight: 800;
    font-size: 13px;
    color: #0f172a;
    background: #fff;
  }

  /* ===== Cards grid ===== */
  .listings{
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 18px;
  }

  .listing{
    width: 100%;
  }

  .card{
    position: relative;
    display: block;
    border-radius: 18px;
    border: 1px solid rgba(255,255,255,0.08);
    box-shadow: 0 16px 40px rgba(9,6,23,0.45);
    overflow: hidden;
    width: 100%;
    aspect-ratio: 3 / 4;
    background: linear-gradient(135deg, #0a1028 0%, #141b3a 100%);
    background-image: var(--flyer, none);
    background-size: cover;
    background-position: center;
    transition: transform 160ms ease, box-shadow 160ms ease;
  }
  .card:hover{
    transform: translateY(-2px);
    box-shadow: 0 20px 55px rgba(2,6,23,0.24);
  }

  .card.no-flyer{
    background-image: linear-gradient(135deg, #0a1028 0%, #141b3a 100%);
  }
  .flyer-overlay{
    position: absolute;
    inset: 0;
    background:
      linear-gradient(180deg, rgba(10,16,40,0.12) 0%, rgba(10,16,40,0.62) 62%, rgba(10,16,40,0.90) 100%);
  }
  .flyer-content{
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    padding: 16px;
    gap: 6px;
  }
  .flyer-top{
    position: absolute;
    top: 14px;
    left: 14px;
    right: 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
  }
  .flyer-price{
    font-size: 14px;
    font-weight: 900;
    color: #fff;
    background: rgba(15,23,42,0.65);
    border: 1px solid rgba(255,255,255,0.14);
    padding: 6px 10px;
    border-radius: 999px;
  }

  .badge{
    display:inline-flex;
    padding: 6px 10px;
    border-radius: 999px;
    background: rgba(255,255,255,0.10);
    border: 1px solid rgba(255,255,255,0.14);
    color: rgba(255,255,255,0.92);
    font-weight: 900;
    font-size: 11px;
    letter-spacing: 0.04em;
    text-transform: uppercase;
  }

  .title{
    margin-top: 0;
    font-weight: 900;
    color: rgba(255,255,255,0.93);
    font-size: 16px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .meta{
    margin-top: 0;
    font-size: 12px;
    color: rgba(226,232,240,0.85);
    font-weight: 750;
  }

  .desc{
    margin-top: 2px;
    font-size: 12px;
    color: rgba(226,232,240,0.72);
  }

  /* ===== Load more ===== */
  .load-wrap{
    display:flex;
    justify-content:center;
    margin-top: 18px;
  }
  #loadMore{
    width: 140px;
    aspect-ratio: 1 / 1;
    border: 0;
    border-radius: 999px;
    background: transparent;
    color: #fff;
    font-weight: 900;
    cursor: pointer;
    position: relative;
    display: grid;
    place-items: center;
  }
  #loadMore::before{
    content: "";
    position: absolute;
    inset: 0;
    border-radius: 999px;
    background: url("{{ url_for('static', filename='img/homedisc.png') }}") center / cover no-repeat;
    -webkit-mask-image: radial-gradient(circle at center, #000 99%, transparent 100%);
    mask-image: radial-gradient(circle at center, #000 99%, transparent 100%);
    transition: transform 400ms ease;
  }
  #loadMore span{
    position: relative;
    z-index: 1;
    background: rgba(15,23,42,0.65);
    border: 1px solid rgba(255,255,255,0.12);
    padding: 8px 12px;
    border-radius: 999px;
    font-size: 12px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
  }
  #loadMore:hover::before{
    transform: rotate(180deg);
  }
  #loadMore:disabled{
    opacity: 0.65;
    cursor:not-allowed;
  }

  #loading{
    text-align:center;
    display:none;
    margin: 10px 0 0;
    color: var(--muted);
    font-weight: 800;
  }

  /* Responsive */
  @media (max-width: 980px){
    .listings{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .searchbar{ grid-template-columns: 1fr 1fr; }
    .searchbar button{ grid-column: 1 / -1; }
  }
  @media (max-width: 560px){
    .listings{ grid-template-columns: 1fr; }
    .hero h1{ font-size: 34px; }
    .section-title{ margin-top: 52px; }
    .section-row{
      flex-direction: column;
      align-items:flex-start;
      margin-top: 52px;
    }
  }
</style>

<div class="djhub-feed djhub-modern">

  <!-- HERO -->
  <div class="hero">
    <div class="hero-inner">
      <div class="hero-content">
        <h1>Find your next event.</h1>
        <p>Check our latest listings!</p>

        <!-- Optional CTAs (front-end only). Remove if you don‚Äôt want extra UI. -->
        <div class="hero-ctas">
          <a class="pill" href="{{ url_for('profile_search') }}">Search for DJs üîç</a>
        </div>
      </div>
    </div>

    <!-- Visual search bar (no backend) -->
    <div class="search-wrap">
      <form class="searchbar" method="get" action="{{ url_for('listings_feed') }}">
        <input name="keyword" placeholder="Keyword" value="{{ request.args.get('keyword','') }}" />
        <select name="genre" aria-label="Genre">
          <option value="">Genre</option>
          {% for g in genres %}
            <option value="{{ g.name }}" {% if request.args.get('genre') == g.name %}selected{% endif %}>
              {{ g.name }}
            </option>
          {% endfor %}
        </select>
        <select name="location" aria-label="Location">
          <option value="">Location</option>
          {% for loc in locations %}
            <option value="{{ loc.name }}" {% if request.args.get('location') == loc.name %}selected{% endif %}>
              {{ loc.name }}
            </option>
          {% endfor %}
        </select>
        <button type="submit">Search</button>
      </form>
    </div>
    
  </div>

  <div class="wrap">
    <div class="section-row">
      <div class="section-title">Latest gigs</div>
      <form class="sort-form" method="get" action="{{ url_for('listings_feed') }}">
        <span class="sort-label">Sort by:</span>
        <select name="sort" aria-label="Sort">
          <option value="newest" {% if request.args.get('sort','newest') == 'newest' %}selected{% endif %}>Newest</option>
          <option value="oldest" {% if request.args.get('sort') == 'oldest' %}selected{% endif %}>Oldest</option>
          <option value="price_asc" {% if request.args.get('sort') == 'price_asc' %}selected{% endif %}>Budget: Lowest</option>
          <option value="price_desc" {% if request.args.get('sort') == 'price_desc' %}selected{% endif %}>Budget: Highest</option>
        </select>
        <input type="hidden" name="keyword" value="{{ request.args.get('keyword','') }}">
        <input type="hidden" name="genre" value="{{ request.args.get('genre','') }}">
        <input type="hidden" name="location" value="{{ request.args.get('location','') }}">
      </form>
    </div>

    <!-- KEEP your ids/classes so JS/back-end remains unchanged -->
    <ul id="listing-feed" class="listings">
      {% for l in listings %}
        <li class="listing">
          <a class="card tilt-card {% if not l.cover_image_url %}no-flyer{% endif %}"
             href="{{ url_for('listing_detail', listing_id=l.id) }}"
             {% if l.cover_image_url %}style="--flyer:url('{{ l.cover_image_url }}');"{% endif %}>
            <div class="flyer-overlay"></div>
            <div class="flyer-top">
              <span class="badge">{{ l.genres or "Gig" }}</span>
              <span class="flyer-price">{% if l.budget %}${{ l.budget }}{% else %}Open Budget{% endif %}</span>
            </div>
            <div class="flyer-content">
              <div class="title">{{ l.title }}</div>
              <div class="meta">
                {{ l.city or "Location TBA" }}{% if l.date %} ‚Ä¢ {{ l.date }}{% endif %}{% if l.time %} ‚Ä¢ {{ l.time }}{% endif %}
              </div>
              <div class="desc">Tap to view details.</div>
            </div>
          </a>
        </li>
      {% else %}
        <li style="color:#64748b; font-weight:800; padding:12px;">No listings yet.</li>
      {% endfor %}
    </ul>

    {% if has_next %}
      <div class="load-wrap">
        <button id="loadMore" data-next="{{ next_page }}"><span>Load more</span></button>
      </div>
    {% endif %}
    <div id="loading" hidden>Loading‚Ä¶</div>
  </div>
</div>

<script>
  const hero = document.querySelector(".hero");
  if (hero) {
    const onScroll = () => {
      const offset = Math.min(80, window.scrollY * 0.2);
      hero.style.setProperty("--parallax-y", `calc(50% + ${offset}px)`);
    };
    window.addEventListener("scroll", onScroll, { passive: true });
    onScroll();
  }

  // === Your existing backend stays identical; just render new card markup ===
  const btn = document.getElementById('loadMore');
  const feed = document.getElementById('listing-feed');
  const loading = document.getElementById('loading');

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  if (btn) {
    btn.addEventListener('click', async () => {
      const next = btn.getAttribute('data-next');
      if (!next) return;

      loading.style.display = 'block';
      btn.disabled = true;

      const params = new URLSearchParams(window.location.search);
params.set("page", next);
const res = await fetch(`/api/listings?${params.toString()}`);

      const data = await res.json();
      const listings = data.listings || [];

      listings.forEach(l => {
        const li = document.createElement('li');
        li.className = 'listing';
        const flyerStyle = l.cover_image_url ? `style="--flyer:url('${esc(l.cover_image_url)}');"` : "";
        const flyerClass = l.cover_image_url ? "" : "no-flyer";
        li.innerHTML = `
          <a class="card tilt-card ${flyerClass}" href="/l/${esc(l.id)}" ${flyerStyle}>
            <div class="flyer-overlay"></div>
            <div class="flyer-top">
              <span class="badge">${esc(l.genres || "Gig")}</span>
              <span class="flyer-price">${l.budget ? '$' + esc(l.budget) : 'Open Budget'}</span>
            </div>
            <div class="flyer-content">
              <div class="title">${esc(l.title || "")}</div>
              <div class="meta">
                ${esc(l.city || "Location TBA")}${l.date ? ' ‚Ä¢ ' + esc(l.date) : ''}${l.time ? ' ‚Ä¢ ' + esc(l.time) : ''}
              </div>
              <div class="desc">Tap to view details.</div>
            </div>
          </a>
        `;
        feed.appendChild(li);
      });

      loading.style.display = 'none';
      if (data.has_next) {
        btn.setAttribute('data-next', data.next_page);
        btn.disabled = false;
      } else {
        btn.remove();
      }
    });
  }

  const sortSelect = document.querySelector('.sort-form select[name="sort"]');
  if (sortSelect) {
    sortSelect.addEventListener('change', () => {
      sortSelect.form.submit();
    });
  }
</script>

{% endblock %}
  .card-img{
    width: 100%;
    height: 160px;
    border-radius: 10px;
    object-fit: cover;
    margin-bottom: 10px;
    border: 1px solid rgba(255,255,255,0.08);
  }
  .card-body{
    flex: 1;
    min-width: 0;
  }
  .card-img{
    width: 223px;
    height: 223px;
    max-width: 223px;
    max-height: 223px;
    border-radius: 10px;
    object-fit: cover;
    border: 1px solid rgba(255,255,255,0.08);
    margin-left: 12px;
    padding: 4px;
    align-self: center;
    flex: 0 0 223px;
  }
