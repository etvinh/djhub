{% extends "base.html" %}
{% block title %}My Profile Â· DJHub{% endblock %}

{% block content %}
<style>
  :root{
    --card: rgba(255,255,255,0.92);
    --text: #0f172a;
    --muted: #64748b;
    --border: rgba(15,23,42,0.12);
    --shadow: 0 18px 50px rgba(15,23,42,0.12);
    --radius: 18px;
    --blue: #4f7cff;
  }

  .profile-page *{ box-sizing: border-box; }

  .profile-page{
    max-width: 980px;
    margin: 22px auto;
    padding: 0 16px 80px;
    font-family: var(--font);
    color: var(--text);
  }

  .profile-hero{
    position: relative;
    border-radius: var(--radius);
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.12);
    box-shadow: 0 14px 40px rgba(9,6,23,0.35);
    background: linear-gradient(135deg, #0a1028 0%, #141b3a 100%);
  }

  .profile-hero-inner{
    display:flex;
    gap: 16px;
    align-items:center;
    padding: 18px;
  }

  .avatar{
    width: 96px;
    height: 96px;
    border-radius: 999px;
    object-fit: cover;
    border: 1px solid rgba(255,255,255,0.16);
    background: rgba(255,255,255,0.08);
    flex: 0 0 auto;
  }
  .avatar-wrap{
    position: relative;
    display: inline-flex;
    align-items:center;
    justify-content:center;
    width: 96px;
    height: 96px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.16);
    background: rgba(255,255,255,0.08);
    cursor: pointer;
  }
  .avatar-wrap .material-symbols-outlined{
    font-size: 42px;
    color: rgba(255,255,255,0.8);
  }
  .edit-avatar{
    position: absolute;
    right: -4px;
    bottom: -4px;
    width: 32px;
    height: 32px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.16);
    background: rgba(15,23,42,0.75);
    display:flex;
    align-items:center;
    justify-content:center;
    color: #fff;
    cursor: pointer;
  }
  .edit-avatar .material-symbols-outlined{ font-size: 18px; }

  .hero-main{
    flex: 1;
    min-width: 0;
  }

  .name{
    font-size: 26px;
    font-weight: 950;
    letter-spacing: -0.02em;
    line-height: 1.1;
    color: #fff;
    margin: 0;
  }

  .handle{
    margin-top: 6px;
    color: rgba(226,232,240,0.75);
    font-weight: 800;
    font-size: 13px;
    display:flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items:center;
  }

  .card{
    background: linear-gradient(135deg, #0a1028 0%, #141b3a 100%);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: var(--radius);
    box-shadow: 0 14px 40px rgba(9,6,23,0.35);
    padding: 16px;
    margin-top: 14px;
  }

  .card h2{
    margin: 0 0 8px 0;
    font-size: 12px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    font-weight: 950;
    color: #fff;
  }

  .form-grid{
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 14px;
  }
  .field{
    display:flex;
    flex-direction:column;
    gap: 6px;
  }
  .field label{
    font-size: 12px;
    font-weight: 900;
    color: rgba(226,232,240,0.75);
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }
  .field input,
  .field select,
  .field textarea{
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.14);
    padding: 10px 12px;
    font-size: 14px;
    font-weight: 600;
    color: #fff;
    background: rgba(255,255,255,0.08);
  }
  .field textarea{
    min-height: 120px;
    resize: vertical;
  }
  .full{
    grid-column: 1 / -1;
  }
  .actions{
    margin-top: 16px;
    display:flex;
    align-items:center;
    gap: 12px;
  }
  .primary-btn{
    height: 44px;
    padding: 0 16px;
    border-radius: 12px;
    border: 0;
    background: var(--blue);
    color: #fff;
    font-weight: 900;
    cursor: pointer;
  }
  .modal{
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(2,6,23,0.55);
    z-index: 50;
  }
  .modal.open{ display:flex; }
  .modal-card{
    width: 100%;
    max-width: 420px;
    background: rgba(12,18,34,0.92);
    border-radius: 16px;
    padding: 16px;
    border: 1px solid rgba(255,255,255,0.14);
    box-shadow: 0 18px 50px rgba(15,23,42,0.35);
    color: #fff;
  }
  .modal-title{
    font-weight: 900;
    color: #fff;
    margin: 0 0 8px 0;
  }
  .modal-actions{
    margin-top: 12px;
    display:flex;
    gap: 8px;
    justify-content:flex-end;
  }
  .ghost-link{
    color: #2563eb;
    font-weight: 800;
    text-decoration: none;
  }
  @media (max-width: 720px){
    .form-grid{ grid-template-columns: 1fr; }
  }
</style>

<div class="profile-page">
  <div class="profile-hero">
    <div class="profile-hero-inner">
      <div class="avatar-wrap" id="avatarTrigger" role="button" aria-label="Change profile picture">
        {% if profile and profile.avatar_url %}
          <img class="avatar" src="{{ profile.avatar_url }}" alt="Avatar" />
        {% else %}
          <span class="material-symbols-outlined" aria-hidden="true">account_circle</span>
        {% endif %}
        <span class="edit-avatar" id="avatarEditBtn" aria-hidden="true">
          <span class="material-symbols-outlined">edit</span>
        </span>
      </div>
      <div class="hero-main">
        <h1 class="name">My profile</h1>
        <div class="handle">@{{ current_user.username }}</div>
      </div>
    </div>
  </div>

  <form method="POST" action="{{ url_for('my_profile') }}" enctype="multipart/form-data">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div class="card">
      <h2>Profile basics</h2>
      <div class="form-grid">
        <div class="field">
          <label for="profile_type">Profile type</label>
          <select id="profile_type" name="profile_type">
            {% set current_type = form.get('profile_type', profile.profile_type if profile else 'dj') %}
            <option value="dj" {% if current_type == 'dj' %}selected{% endif %}>DJ profile</option>
            <option value="planner" {% if current_type == 'planner' %}selected{% endif %}>Event planner profile</option>
          </select>
        </div>
        <div class="field">
          <label for="username">Username</label>
          <input
            id="username"
            type="text"
            value="@{{ current_user.username }}"
            disabled
          >
        </div>
        <div class="field">
          <label for="city">City</label>
          <select id="city" name="city">
            <option value="" {% if not form.get('city') and not (profile and profile.city) %}selected{% endif %}>Select location</option>
            {% for loc in locations %}
              <option value="{{ loc.name }}"
                {% if form.get('city') == loc.name or (not form.get('city') and profile and profile.city == loc.name) %}selected{% endif %}>
                {{ loc.name }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="field dj-only">
          <label for="genres">Genres</label>
          <select id="genres" name="genres">
            <option value="" {% if not form.get('genres') and not (profile and profile.genres) %}selected{% endif %}>Select genre</option>
            {% for g in genres %}
              <option value="{{ g.name }}"
                {% if form.get('genres') == g.name or (not form.get('genres') and profile and profile.genres == g.name) %}selected{% endif %}>
                {{ g.name }}
              </option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Media</h2>
      <div class="form-grid">
        <div class="field full dj-only">
          <label>Top tracks</label>
          <div style="display:grid;gap:10px;">
            <div style="display:grid;grid-template-columns: 1fr 1fr;gap:10px;">
              <input
                name="track_title_1"
                type="text"
                placeholder="Track 1 title"
                value="{{ form.get('track_title_1', (track_map.get(1).title if track_map and track_map.get(1) else '')) }}"
              >
              <div style="display:flex;align-items:center;gap:8px;">
                <input
                  id="track_file_1"
                  name="track_file_1"
                  type="file"
                  accept="audio/*"
                >
                <span id="trackFileName1" style="color:rgba(226,232,240,0.7);font-size:11px;font-weight:700;white-space:nowrap;">
                  {% if track_map and track_map.get(1) %}{{ track_map.get(1).audio_url.split('/')[-1] }}{% endif %}
                </span>
              </div>
            </div>
            <div style="display:grid;grid-template-columns: 1fr 1fr;gap:10px;">
              <input
                name="track_title_2"
                type="text"
                placeholder="Track 2 title"
                value="{{ form.get('track_title_2', (track_map.get(2).title if track_map and track_map.get(2) else '')) }}"
              >
              <div style="display:flex;align-items:center;gap:8px;">
                <input
                  id="track_file_2"
                  name="track_file_2"
                  type="file"
                  accept="audio/*"
                >
                <span id="trackFileName2" style="color:rgba(226,232,240,0.7);font-size:11px;font-weight:700;white-space:nowrap;">
                  {% if track_map and track_map.get(2) %}{{ track_map.get(2).audio_url.split('/')[-1] }}{% endif %}
                </span>
              </div>
            </div>
            <div style="display:grid;grid-template-columns: 1fr 1fr;gap:10px;">
              <input
                name="track_title_3"
                type="text"
                placeholder="Track 3 title"
                value="{{ form.get('track_title_3', (track_map.get(3).title if track_map and track_map.get(3) else '')) }}"
              >
              <div style="display:flex;align-items:center;gap:8px;">
                <input
                  id="track_file_3"
                  name="track_file_3"
                  type="file"
                  accept="audio/*"
                >
                <span id="trackFileName3" style="color:rgba(226,232,240,0.7);font-size:11px;font-weight:700;white-space:nowrap;">
                  {% if track_map and track_map.get(3) %}{{ track_map.get(3).audio_url.split('/')[-1] }}{% endif %}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card dj-only">
      <h2>Socials</h2>
      <div class="form-grid">
        <div class="field">
          <label for="instagram_url">Instagram URL</label>
          <input
            id="instagram_url"
            name="instagram_url"
            type="url"
            placeholder="https://instagram.com/yourname"
            value="{{ form.get('instagram_url', (profile.instagram_url or '') if profile else '') }}"
          >
        </div>
        <div class="field">
          <label for="spotify_url">Spotify URL</label>
          <input
            id="spotify_url"
            name="spotify_url"
            type="url"
            placeholder="https://open.spotify.com/artist/..."
            value="{{ form.get('spotify_url', (profile.spotify_url or '') if profile else '') }}"
          >
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Bio</h2>
      <div class="form-grid">
        <div class="field full">
          <textarea id="bio" name="bio">{{ form.get('bio', profile.bio if profile else '') }}</textarea>
        </div>
      </div>
    </div>

    <div class="modal" id="avatarModal" aria-hidden="true">
      <div class="modal-card">
        <div class="modal-title">Change profile picture</div>
        <div class="field">
          <input id="avatar_file" name="avatar_file" type="file" accept="image/*">
          <div id="avatarFileName" style="margin-top:6px;color:#64748b;font-weight:800;font-size:12px;"></div>
        </div>
        <div class="modal-actions">
          <button type="button" class="msg-btn secondary" id="avatarCancel">Cancel</button>
          <button type="button" class="msg-btn" id="avatarOk">Done</button>
        </div>
      </div>
    </div>

    <div class="modal" id="profileTypeModal" aria-hidden="true">
      <div class="modal-card">
        <div class="modal-title">Switch profile type?</div>
        <div style="color:rgba(226,232,240,0.85);font-weight:700;font-size:13px;line-height:1.4;">
          Switching profile type will remove the current profile settings for this account.
        </div>
        <div class="modal-actions">
          <button type="button" class="msg-btn secondary" id="profileTypeCancel">Cancel</button>
          <button type="button" class="msg-btn" id="profileTypeConfirm">Switch profile</button>
        </div>
      </div>
    </div>

    <div class="actions">
      <button type="submit" class="primary-btn">Save profile</button>
    </div>
  </form>
</div>
<script>
  const typeSelect = document.getElementById("profile_type");
  const profileForm = document.querySelector("form[action='{{ url_for('my_profile') }}']");
  const initialProfileType = typeSelect?.value || "dj";
  const djFields = document.querySelectorAll(".dj-only");
  function toggleDjFields(){
    const isDj = typeSelect?.value === "dj";
    djFields.forEach(el => {
      el.style.display = isDj ? "" : "none";
    });
  }
  typeSelect?.addEventListener("change", toggleDjFields);
  toggleDjFields();

  const profileTypeModal = document.getElementById("profileTypeModal");
  const profileTypeCancel = document.getElementById("profileTypeCancel");
  const profileTypeConfirm = document.getElementById("profileTypeConfirm");
  let allowTypeSubmit = false;

  function openTypeModal(){
    profileTypeModal?.classList.add("open");
    profileTypeModal?.setAttribute("aria-hidden", "false");
  }
  function closeTypeModal(){
    profileTypeModal?.classList.remove("open");
    profileTypeModal?.setAttribute("aria-hidden", "true");
  }

  profileForm?.addEventListener("submit", (e) => {
    const currentType = typeSelect?.value || "dj";
    if (currentType !== initialProfileType && !allowTypeSubmit) {
      e.preventDefault();
      openTypeModal();
    }
  });

  profileTypeCancel?.addEventListener("click", () => {
    if (typeSelect) {
      typeSelect.value = initialProfileType;
      toggleDjFields();
    }
    closeTypeModal();
  });
  profileTypeConfirm?.addEventListener("click", () => {
    allowTypeSubmit = true;
    closeTypeModal();
    profileForm?.submit();
  });
  profileTypeModal?.addEventListener("click", (e) => {
    if (e.target === profileTypeModal) {
      if (typeSelect) {
        typeSelect.value = initialProfileType;
        toggleDjFields();
      }
      closeTypeModal();
    }
  });

  const avatarModal = document.getElementById("avatarModal");
  const avatarTrigger = document.getElementById("avatarTrigger");
  const avatarEditBtn = document.getElementById("avatarEditBtn");
  const avatarCancel = document.getElementById("avatarCancel");
  const avatarOk = document.getElementById("avatarOk");
  const avatarFileInput = document.getElementById("avatar_file");
  const avatarFileName = document.getElementById("avatarFileName");
  function openAvatarModal(){
    if (avatarModal) {
      avatarModal.classList.add("open");
      avatarModal.setAttribute("aria-hidden", "false");
    }
  }
  function closeAvatarModal(){
    if (avatarModal) {
      avatarModal.classList.remove("open");
      avatarModal.setAttribute("aria-hidden", "true");
    }
  }
  avatarTrigger?.addEventListener("click", openAvatarModal);
  avatarEditBtn?.addEventListener("click", openAvatarModal);
  avatarCancel?.addEventListener("click", () => {
    if (avatarFileInput) avatarFileInput.value = "";
    if (avatarFileName) avatarFileName.textContent = "";
    closeAvatarModal();
  });
  avatarOk?.addEventListener("click", () => {
    const file = avatarFileInput?.files?.[0];
    if (!file) {
      if (avatarFileName) avatarFileName.textContent = "Please select an image first.";
      return;
    }
    const previewUrl = URL.createObjectURL(file);
    const existingImg = avatarTrigger?.querySelector("img");
    if (existingImg) {
      existingImg.src = previewUrl;
    } else if (avatarTrigger) {
      avatarTrigger.innerHTML = `
        <img class="avatar" src="${previewUrl}" alt="Avatar" />
        <span class="edit-avatar" id="avatarEditBtn" aria-hidden="true">
          <span class="material-symbols-outlined">edit</span>
        </span>
      `;
    }
    closeAvatarModal();
  });
  avatarModal?.addEventListener("click", (e) => {
    if (e.target === avatarModal) closeAvatarModal();
  });
  avatarFileInput?.addEventListener("change", () => {
    const file = avatarFileInput.files?.[0];
    if (avatarFileName) {
      avatarFileName.textContent = file ? `Selected: ${file.name}` : "";
    }
  });

  function wireTrackFileName(inputId, labelId){
    const input = document.getElementById(inputId);
    const label = document.getElementById(labelId);
    if (!input || !label) return;
    input.addEventListener("change", () => {
      const file = input.files?.[0];
      label.textContent = file ? file.name : label.textContent;
    });
  }
  wireTrackFileName("track_file_1", "trackFileName1");
  wireTrackFileName("track_file_2", "trackFileName2");
  wireTrackFileName("track_file_3", "trackFileName3");
</script>
{% endblock %}
